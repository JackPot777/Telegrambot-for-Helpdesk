# Состав файлов и каталогов, необходимых для работы бота

Бот состоит из следующих модулей:

- bot.py

Основной модуль, который запускается как служба на Linux-сервере.
Описывает и запускает webhook-сервер, который получает обновления от сервера Telegram,
описывает хэндлеры сообщений (правила обработки сообщений),

- db.py

Модуль описывает модель данных, которая реализуется в базе данных. В модуле описаны
функции для работы с базой данных, осуществляющие SQL-запросы к базе и возвращающие ответ
в виде внутреннего типа данных Python,

- util.py

  Модуль содержит функции, вызываемые в основном модуле:
  - отправка сообщения аутентификации,
  - формирование текстовой информации о пользователе,
  - формирование клавиатуры,
  - таймер закрытия коммуникации по таймауту,
  - взятие неназначенной коммуникации нажатием кнопки на клавиатуре,
  - закрытие текущей коммуникации нажатием кнопки на клавиатуре,
  - архивирование коммуникации,
  - сохранение вложений (фото и документов) в папку с архивом коммуникации,
  - отправка предупреждения о завершающемся свободном месте на диске сервера на
электронную почту,
  - разбиение на части архива коммуникации большого объема перед отправкой его
сообщением (workaround для ограничений Telegram на максимальный размер сообщения),

- config.py

  Модуль содержит конфигурационные данные бота:
  - токен бота,
  - параметры webhook-сервера,
  - путь к файлу базы данных,
  - путь к папке с архивами коммуникаций,
  - определение chat_id и отображаемых имен специалистов, групп специалистов и контроллеров,
  - описание некоторых типовых текстовых сообщений, многократно используемых хэндлерами,
  - параметры таймера сообщений,
  - параметры подключения к серверу электронной почты,

В каталоге с описанными модулями находятся следующие каталоги:

- archive – каталог с текстовыми файлами архивов сообщений и копиями пересылаемых ботом
файлов (фото и документы),
- cert – каталог с файлами сертификата и закрытого ключа для организации SSL-соединения с
сервером Telegram,
- db – каталог с файлом базы данных бота.

# Описание работы бота

Служба, отдельно настраиваемая на Linux-сервере, запускает bot.py при запуске сервера.
Клиенты (пользователи, специалисты, контроллеры) отправляют боту в личном чате сообщения, 
сервер Telegram их получает и пересылает на наш webhook-сервер, на котором они 
обрабатываются соответствующим хэндлером. Сформированный хэндлером ответ направляется серверу 
Telegram, который пересылает сообщение нужному клиенту. 

Общение с ботом можно предствить в виде следующей последовательности шагов:
 
 - пользователь, впервые обращающийся к боту, направляет ему свое первое сообщение,
 - бот проверяет, что данный пользователь отсутствует в базе данных, вносит нового пользователя 
 в базу данных с набором типовых начальных параметров и отправляет 
 пользователю сообщение с запросом адреса электронной почты пользователя,
 - после получения сообщения с адресом электронной почты и валидации адреса электронной почты 
 пользователя бот отправляет на этот адрес код аутентификации и ожидает ввода пользователем 
 корректного кода,
 - после получения сообщения с корректным кодом аутентификации бот отправляет в сервисную группу,
 в которую входят Специалисты, сообщение об успешной аутентификации нового пользователя. 
 Пользователю бот отправляет сообщение с уведомлением об успешной аутентификации и предложение
ввести текст обращения,
 - после получения сообщения с обращением пользователя бот направляет в сервисную группу
 сообщение о новой коммуникации, в котором отображается информация о пользователе с историей 
 сообщений по открытой коммуникации. С каждым новым сообщением от пользователя бот добавляет 
 текст нового сообщения пользователя в лог коммуникации. Кто-то из специалистов переводит на 
 себя коммуникацию с пользователем, о чем специалист, пользователь и сервисная группа получают 
 соответствующие уведомления. После этого все сообщения от пользователя направляются напрямую 
 специалисту в личный чат с ботом. Пока коммуникация с пользователем открыта, все сообщения 
 от специалиста, направленные им боту в личном чате, уходят пользователю. Бот является 
 посредником между пользователем и специалистом,
 - по окончании общения с пользователем специалист закрывает коммуникацию, о чем специалист
и сервисная группа получают соответствующие уведомления,
 - следующее сообщение от пользователя открывает новую коммуникацию, о чем сервисная группа
получает соответствующее сообщение, и т.д.

Если в текущей коммуникации после очередного сообщения специалиста пользователь не отвечает 
более 1 часа (настраивается в config.py), коммуникация автоматически закрывается по таймауту 
с отправкой соответствующих уведомлений.
Бот не регистрирует заявки в сервисдеске! Это делает специалист по результатам общения с
пользователем.

Общение реализовано в соответствии с принципами:
 
 - в текущий момент пользователь либо имеет одну активную коммуникацию, либо не имеет активной
коммуникации. Двух коммуникаций пользователь иметь не может,
 - аналогично, специалист либо имеет одну активную коммуникацию, либо не имеет активной 
коммуникации. Двух активных коммуникаций специалист иметь не может.

# Сервисное меню

При вводе символа «/» или нажатии соответствующей кнопки в Telegram-клиенте во
всплывающем меню появляется команда «/service Сервисное меню». При выборе этой команды отображается Сервисное меню.

## Сервисное меню пользователя

### *Сменить адрес электронной почты*

На этапе аутентификации пользователя бот просит ввести адрес электронной почты, на который 
затем направляется сообщение с кодом аутентификации.
Есть вероятность ошибочного ввода адреса электронной почты, поэтому данный пункт сервисного
меню предусматривает возможность смены адреса электронной почты.
После ввода нового адреса на него отправляется сообщение с кодом аутентификации.
За пределами этапа аутентификации данный функционал не работает, при нажатии этой кнопки
пользователь получает сообщение о невозможности смены адреса электронной почты.

## Сервисное меню специалиста

### *Есть ли у меня текущая коммуникация?*
Выполняется проверка, имеет ли данный специалист текущую коммуникацию с кем-то из
пользователей. Выдается соответствующее сообщение.

### *Закрыть текущую коммуникацию*
При закрытии текущей коммуникации специалиста производится архивирование истории
общения по коммуникации, отправляются сообщения о закрытии коммуникации специалисту и во все
сервисные группы.

### *Перевести мою текущую коммуникацию в неназначенные*
При переводе текущей коммуникации специалиста в неназначенные ему направляется сообщение о
переводе коммуникации, во все сервисные группы направляется сообщение о переводе
коммуникации в статус незакрепленной с кнопкой перевода коммуникации. Нажатием кнопки
другой специалист может перевести коммуникацию на себя.

### *Список неназначенных коммуникаций*
Производится запрос к базе данных с определением пользователей, имеющих коммуникации,
находящиеся в незакрепленном состоянии. Специалисту направляются сообщения по каждому
пользователю с кнопкой перевода соответствующей коммуникации.

### *Список пользователей в базе*
Выводится полный список пользователей в базе данных с описанием текущего состояния каждого 
пользователя.

### *Запрос истории сообщений по пользователям*
При запросе истории сообщений выводится клавиатура с кнопкой для каждого пользователя.
Нажатие на кнопку с пользователем выполняет следующие действия:
- при наличии у пользователя активной коммуникации выводится история сообщений по этой
коммуникации и кнопка для показа архива сообщений по предыдущим коммуникациям
пользователя,
- при отсутствии у пользователя активной коммуникации направляется соответствующее
сообщение и кнопки для показа архива сообщений по последней и по всем коммуникациям
пользователя.

## Сервисное меню контроллера

В текущей редакции сервисное меню отсутствует.

## Закрытие коммуникации по таймауту

В модели данных о пользователе присутствуют поля для записи времени отправки сообщения.
Время отправки сообщения пользователем начинает фиксироваться после закрепления открытой
им коммуникации за специалистом. Время отправки сообщения специалистом фиксируется до тех пор,
 пока он имеет текущую коммуникацию с пользователем.
С определенным в конфигурации интервалом происходит проверка условия: если последнее на
текущий момент сообщение в коммуникации было отправлено специалистом, и пользователь не
ответил на него в течение определенного в конфигурации времени, коммуникация автоматически
закрывается с отправкой соответствующих уведомлений специалисту и всем сервисным группам.

# Просмотр журнала службы

Посмотреть журнал службы можно следующей командой
```
[root@localhost ~]# journalctl --unit=telegrambot
```
